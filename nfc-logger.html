<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Register NFC Pass</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    label, select, button { display: block; margin: 1em auto; font-size: 1em; }
    #status { margin-top: 1em; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Cashier: Register NFC Pass</h2>

  <label>Pass Duration:
    <select id="duration">
      <option value="1">1 Day</option>
      <option value="3">3 Days</option>
      <option value="5">5 Days</option>
    </select>
  </label>

  <button id="startScan">Scan Card</button>
  <div id="status">Waiting to scan...</div>

  <script>
    const startScanBtn = document.getElementById('startScan');
    const status = document.getElementById('status');
    const durationSelect = document.getElementById('duration');

    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz6FQBpf9zn2zbA0Dy5dWoEL43ZJe0-QAsfsZdKcbNEN43glJAJIqBz-d0YIMICxgi86A/exec';

    let isScanning = false;

    startScanBtn.addEventListener('click', async () => {
      if (isScanning) {
        status.textContent = 'Already scanning. Tap a card.';
        return;
      }

      if (!('NDEFReader' in window)) {
        status.textContent = 'Web NFC not supported on this device.';
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        isScanning = true;

        status.textContent = 'Scanning... Tap a card.';

        ndef.onreading = async (event) => {
          const uid = event.serialNumber;
          const duration = durationSelect.value;

          if (!uid) {
            status.textContent = '❌ UID not detected.';
            return;
          }

          status.textContent = `Card UID: ${uid}, ${duration} day pass`;

          try {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?uid=${encodeURIComponent(uid)}&duration=${duration}`);
            const result = await response.text();
            if (result.includes("status=registered")) {
              status.textContent = "✅ New card registered";
            } else if (result.includes("status=already_registered")) {
              status.textContent = "⚠️ Card already active or eligible";
            } else if (result.includes("re-registered")) {
              status.textContent = "🔁 Card re-registered (was expired)";
            } else {
              status.textContent = `❌ Unknown response: ${result}`;
            }
          } catch (err) {
            status.textContent = `❌ Failed to register card: ${err}`;
          }
        };

        ndef.onreadingerror = () => {
          status.textContent = 'Error reading NFC card.';
        };

      } catch (error) {
        status.textContent = `NFC Scan Error: ${error}`;
      }
    });
  </script>
</body>
</html>
