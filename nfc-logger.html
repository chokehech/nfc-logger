<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Register NFC Pass</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    label, select { display: block; margin: 1em auto; font-size: 1em; }
    #status { margin-top: 1em; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Cashier: Register NFC Pass</h2>

  <label>Pass Duration:
    <select id="duration">
      <option value="1">1 Day</option>
      <option value="3">3 Days</option>
      <option value="5">5 Days</option>
    </select>
  </label>

  <div id="status">Initializing NFC scanner...</div>

  <script>
    const status = document.getElementById('status');
    const durationSelect = document.getElementById('duration');

    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVBPOSMIW8_SvFIHMjNiZHvy3RyOJvDQYIu_Yltg_c3krKnqimDiZX5MVHKSieCPIT0g/exec';

    async function startScan() {
      if (!('NDEFReader' in window)) {
        status.textContent = 'Web NFC not supported on this device.';
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        status.textContent = 'Ready. Tap a card.';

        ndef.onreading = async (event) => {
          const uid = event.serialNumber;
          const duration = durationSelect.value;

          if (!uid) {
            status.textContent = '‚ùå UID not detected.';
            return;
          }

          status.textContent = `‚è≥ Registering card UID: ${uid} (${duration} day pass)...`;

          try {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?uid=${encodeURIComponent(uid)}&duration=${duration}`);
            const result = await response.text();

            if (result.includes("status=registered")) {
              status.textContent = "‚úÖ New card registered";
            } else if (result.includes("status=re_registered")) {
              status.textContent = "üîÅ Expired card re-registered";
            } else if (result.includes("status=already_registered")) {
              status.textContent = "‚ö†Ô∏è Card is already active or eligible";
            } else {
              status.textContent = `‚ùå Unknown response: ${result}`;
            }

          } catch (err) {
            status.textContent = `‚ùå Failed to register card: ${err}`;
          }
        };

        ndef.onreadingerror = () => {
          status.textContent = '‚ùå Error reading NFC card.';
        };

      } catch (error) {
        status.textContent = `‚ùå NFC Scan Error: ${error}`;
      }
    }

    // Auto-start on load
    window.addEventListener('load', startScan);
  </script>
</body>
</html>
